# Uncomment this line to define a global platform for your project
platform :ios, '15.0'

# CocoaPods analytics sends network stats synchronously affecting flutter build latency.
ENV['COCOAPODS_DISABLE_STATS'] = 'true'

project 'Runner', {
  'Debug' => :debug,
  'Profile' => :release,
  'Release' => :release,
}

def flutter_root
  generated_xcode_build_settings_path = File.expand_path(File.join('..', 'Flutter', 'Generated.xcconfig'), __FILE__)
  unless File.exist?(generated_xcode_build_settings_path)
    raise "#{generated_xcode_build_settings_path} must exist. If you're running pod install manually, make sure flutter pub get is executed first"
  end

  File.foreach(generated_xcode_build_settings_path) do |line|
    matches = line.match(/FLUTTER_ROOT\=(.*)/)
    return matches[1].strip if matches
  end
  raise "FLUTTER_ROOT not found in #{generated_xcode_build_settings_path}. Try deleting Generated.xcconfig, then run flutter pub get"
end

require File.expand_path(File.join('packages', 'flutter_tools', 'bin', 'podhelper'), flutter_root)

flutter_ios_podfile_setup

target 'Runner' do
  use_frameworks!

  flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))
  target 'RunnerTests' do
    inherit! :search_paths
  end
end

post_install do |installer|
  installer.pods_project.targets.each do |target|
    flutter_additional_ios_build_settings(target)
    target.build_configurations.each do |config|
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '15.0'
      config.build_settings['ENABLE_BITCODE'] = 'NO'

      # Fix DKImagePickerController/DKPhotoGallery iPad asset catalog issue
      # Set iPhone only as targeted device to avoid iPad simulator lookup
      if target.name.include?('DK')
        config.build_settings['TARGETED_DEVICE_FAMILY'] = '1'
      end

      # Skip asset catalog validation for all pods
      config.build_settings['ASSETCATALOG_COMPILER_SKIP_VALIDATION'] = 'YES'
      config.build_settings['ASSETCATALOG_COMPILER_INCLUDE_STICKER_CONTENT'] = 'NO'

      # Strip bitcode from Naver SDK
      if target.name == 'naveridlogin-sdk-ios'
        config.build_settings['BITCODE_GENERATION_MODE'] = 'none'
      end
    end
  end

  # Also set at project level
  installer.pods_project.build_configurations.each do |config|
    config.build_settings['ASSETCATALOG_COMPILER_SKIP_VALIDATION'] = 'YES'
  end

  # Remove xcassets from ALL DK pods to avoid asset compilation issues
  installer.pods_project.targets.each do |target|
    target.build_phases.each do |phase|
      if phase.is_a?(Xcodeproj::Project::Object::PBXResourcesBuildPhase)
        phase.files.delete_if do |file|
          path = file.file_ref&.path || ''
          path.include?('.xcassets') && (path.include?('DK') || file.file_ref&.real_path&.to_s&.include?('DKImagePickerController') || file.file_ref&.real_path&.to_s&.include?('DKPhotoGallery'))
        end
      end
    end
  end

  # Also physically rename the xcassets folders to prevent actool from finding them
  dk_xcassets = Dir.glob("#{installer.config.project_root}/Pods/DK*/**/*.xcassets")
  dk_xcassets.each do |xcasset|
    backup_path = "#{xcasset}.disabled"
    FileUtils.mv(xcasset, backup_path) if File.exist?(xcasset) && !File.exist?(backup_path)
  end

  # Strip bitcode from all frameworks
  bitcode_strip_path = `xcrun --find bitcode_strip`.chomp
  Dir.glob("#{installer.config.project_root}/Pods/**/*.framework").each do |framework|
    binary_path = "#{framework}/#{File.basename(framework, '.framework')}"
    if File.exist?(binary_path)
      system("#{bitcode_strip_path} '#{binary_path}' -r -o '#{binary_path}' 2>/dev/null || true")
    end
  end
end
